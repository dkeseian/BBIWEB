000100170622/* This procedure is used if the user has checked the From Store    */
000200170622/* checkbox on the Transfer Log report. */
000300170622
000400170622CREATE OR REPLACE PROCEDURE BBIWEB.ST_LOG3
000500170531    (IN AFROMSTORE INT,
000600170531        ATOSTORE   INT,
000700170531        AFROMDEPT  INT,
000800170602        ATODEPT    INT,
000900170602        AFROMDATE  CHAR(10),
001000170810        ATODATE    CHAR(10),
001100180327        ACREATEPRF CHAR(20),
001101180327        ARETAILPRC CHAR(1))
001200170531
001300170531RESULT SETS 1
001400170602 LANGUAGE SQL
001500170602 BEGIN
001600170602 Declare SQLQuery  varchar(600);
001700170531
001800170602 DECLARE C1 CURSOR WITH RETURN FOR  SQL_STATEMENT;
001900170531    /* Build the Transact-SQL String with the input parameters */
002000170602 Set SQLQuery = ' SELECT TO_CHAR(A.CREATEDTE, ''YYYY-MM-DD HH24:MI:SS'')';
002100170602 Set SQLQuery = SQLQuery || ' AS CHARCRTDTE,';
002200170602 Set SQLQuery = SQLQuery || ' IFNULL(C.TRNCOMMENT, '''') AS TRNCOMMENT,';
002300170602 Set SQLQuery = SQLQuery || ' A.* FROM BBIWEB.BBV170AH A';
002400170602 Set SQLQuery = SQLQuery || ' LEFT JOIN BBIWEB.BBP170B C';
002500170602 Set SQLQuery = SQLQuery || ' ON C.TRANSFERID = A.TRANSFERID AND LINESEQ = 0';
002600170602 Set SQLQuery = SQLQuery || ' where (1=1) ';
002700170622
002800170622 /* The user selected From Store All. That means the To Store is populated   */
002900170623 Set SQLQuery = SQLQuery || ' And (TOSTORE = ' || ATOSTORE || ')';
003000170531
003100170622    /* check for the condition and build the WHERE clause accordingly */
003200170602 If AFROMDEPT Is Not Null    then
003300170602    Set SQLQuery = SQLQuery || ' And (FROMDEPT = ' || AFROMDEPT || ')';
003400170602 END IF;
003500170531
003600170602 If ATODEPT Is Not Null     then
003700170602    Set SQLQuery = SQLQuery ||  ' And (TODEPT = ' || ATODEPT || ')';
003800170602  END IF;
003900170602
004000170602 If (AFROMDATE Is Not Null) AND (ATODATE Is Not Null)   then
004100170605  Set SQLQuery = SQLQuery || ' And DATE(a.CREATEDTE)';
004200170605  Set SQLQuery = SQLQuery || ' BETWEEN date(''' || AFROMDATE || ''') and ';
004300170605  Set SQLQuery = SQLQuery || ' date(''' || ATODATE || ''')' ;
004400170602 END IF;
004500170531
004600170811 If ACREATEPRF Is Not Null     then
004700170811    Set SQLQuery = SQLQuery ||  ' And (A.CREATEPRF  = ''' || ACREATEPRF ||
004800170811        ''')';
004900170811  END IF;
005000170811
005001180327 If ARETAILPRC Is Not Null     then
005002180327    Set SQLQuery = SQLQuery ||  ' And (A.RETAILPRC  = ''' || ARETAILPRC ||
005003180327        ''')';
005004180327  Else    Set SQLQuery = SQLQuery ||  ' And (A.RETAILPRC  is null)' ;
005005180327  END IF;
005006180327
005100170602 Set SQLQuery = SQLQuery || ' ORDER BY CREATEDTE DESC, FROMSTORE' ;
005200170531
005300170602 PREPARE SQL_STATEMENT FROM SQLQuery;
005400170531
005500170602 OPEN C1;
005600170602 END
