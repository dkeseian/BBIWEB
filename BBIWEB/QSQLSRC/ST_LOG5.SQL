000100180613CREATE OR REPLACE PROCEDURE BBIWEB.ST_LOG5
000200170608    (IN AFROMSTORE INT,
000300170608        ATOSTORE   INT,
000400170608        AFROMDEPT  INT,
000500170608        ATODEPT    INT,
000600170608        AFROMDATE  CHAR(10),
000700170810        ATODATE    CHAR(10),
000800180327        ACREATEPRF CHAR(20),
000900180327        ARETAILPRC CHAR(1))
001100170608
001200170608RESULT SETS 1
001300170608 LANGUAGE SQL
001400170608 BEGIN
001500170608 Declare SQLQuery  varchar(600);
001600170608
001700170608 DECLARE C1 CURSOR WITH RETURN FOR  SQL_STATEMENT;
001800170608    /* Build the Transact-SQL String with the input parameters */
001900170608 Set SQLQuery = ' SELECT TO_CHAR(A.CREATEDTE, ''YYYY-MM-DD HH24:MI:SS'')';
002000170608 Set SQLQuery = SQLQuery || ' AS CHARCRTDTE,';
002100170608 Set SQLQuery = SQLQuery || ' IFNULL(C.TRNCOMMENT, '''') AS TRNCOMMENT,';
002200170608 Set SQLQuery = SQLQuery || ' A.* FROM BBIWEB.BBV170AH A';
002300170608 Set SQLQuery = SQLQuery || ' LEFT JOIN BBIWEB.BBP170B C';
002400170608 Set SQLQuery = SQLQuery || ' ON C.TRANSFERID = A.TRANSFERID AND LINESEQ = 0';
002500180613 Set SQLQuery = SQLQuery || ' where (1=1)  ' ;
002501180613
002503180615 If AFROMSTORE <> 0    then
002504180613     Set SQLQuery =
002505180613  SQLQuery || ' and ((fromstore <> 0  and tostore =' || AFROMSTORE || ')';
002506180613 Set SQLQuery =
002507180613  SQLQuery || ' or (fromstore =' || AFROMSTORE || ' and tostore <> 0))';
002508180615 Else
002509180615  Set SQLQuery =
002510180615  SQLQuery || ' and (fromstore <> 0  and tostore <> 0)';
002511180613 END IF;
002514180613
002700180613/* check for the condition and build the WHERE clause accordingly */
003800170608 If AFROMDEPT Is Not Null    then
003900170608    Set SQLQuery = SQLQuery || ' And (FROMDEPT = ' || AFROMDEPT || ')';
004000170608 END IF;
004100170608
004200170608 If ATODEPT Is Not Null     then
004300170608    Set SQLQuery = SQLQuery ||  ' And (TODEPT = ' || ATODEPT || ')';
004400170608  END IF;
004500170608
004600170608 If (AFROMDATE Is Not Null) AND (ATODATE Is Not Null)   then
004700170608  Set SQLQuery = SQLQuery || ' And DATE(a.CREATEDTE)';
004800170608  Set SQLQuery = SQLQuery || ' BETWEEN date(''' || AFROMDATE || ''') and ';
004900170608  Set SQLQuery = SQLQuery || ' date(''' || ATODATE || ''')' ;
005000170608 END IF;
005100170811
005200170811 If ACREATEPRF Is Not Null     then
005300170811    Set SQLQuery = SQLQuery ||  ' And (A.CREATEPRF  = ''' || ACREATEPRF ||
005400170811        ''')';
005500170811  END IF;
005600180327
005700180327  If ARETAILPRC Is Not Null     then
005800180327    Set SQLQuery = SQLQuery ||  ' And (A.RETAILPRC  = ''' || ARETAILPRC ||
005900180327        ''')';
006000180327  END IF;
006100180327
006200170608 Set SQLQuery = SQLQuery || ' ORDER BY CREATEDTE DESC, FROMSTORE' ;
006300170608
006400170608 PREPARE SQL_STATEMENT FROM SQLQuery;
006500170608
006600170608 OPEN C1;
006700170608 END
006800170608
